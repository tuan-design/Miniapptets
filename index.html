<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Sổ Tay Tài Chính</title>
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --income-color: #4CAF50;
      --expense-color: #F44336;
      --background-color: #f0f2f5;
      --card-background: #ffffff;
      --text-color: #333;
      --light-text-color: #666;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0, 0, 0, 0.08);
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 10px;
    }
    .header {
      text-align: center;
      padding: 15px 0;
      background-color: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      background-color: var(--card-background);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 60px;
      z-index: 999;
      box-shadow: 0 1px 3px var(--shadow-color);
    }
    .tab-button {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--light-text-color);
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .tab-button.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    .tab-content {
      display: none;
      padding-top: 15px;
    }
    .tab-content.active {
      display: block;
    }
    .card {
      background-color: var(--card-background);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px var(--shadow-color);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow-color);
    }
    h2, h3 {
      margin-top: 0;
      color: var(--primary-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      text-align: center;
      margin-bottom: 15px;
    }
    .summary-item {
      background-color: var(--background-color);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px var(--shadow-color);
      position: relative;
    }
    .summary-item p {
      margin: 0;
      font-size: 14px;
      color: var(--light-text-color);
    }
    .summary-item h4 {
      margin: 5px 0 0;
      font-size: 18px;
      font-weight: 700;
    }
    .summary-item .income { color: var(--income-color); }
    .summary-item .expense { color: var(--expense-color); }
    .summary-item .balance { color: var(--secondary-color); }
    
    .chart-container {
      height: 300px;
      position: relative;
      margin-top: 20px;
    }
    .chart-container canvas {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 10px;
    }
    .category-list {
      list-style-type: none;
      padding: 0;
    }
    .category-list li {
      padding: 8px 0;
      border-bottom: 1px dashed var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .category-list li:last-child {
      border-bottom: none;
    }
    .category-list .label {
      font-weight: 600;
      color: var(--text-color);
    }
    .category-list .amount {
      color: var(--light-text-color);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 16px;
      box-sizing: border-box;
    }
    .form-group textarea {
      resize: vertical;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }
    .btn-danger {
      background-color: var(--expense-color);
      color: white;
    }
    .btn-outline {
      background-color: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }
    .btn-primary:hover { background-color: #43a047; }
    .btn-secondary:hover { background-color: #1e88e5; }
    .btn-danger:hover { background-color: #e53935; }
    
    .loading-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
      font-size: 16px;
      color: var(--light-text-color);
    }
    .loading-indicator.hidden {
      display: none;
    }
    .transaction-list {
      list-style-type: none;
      padding: 0;
    }
    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .transaction-item:hover {
      background-color: #f9f9f9;
    }
    .transaction-item:last-child {
      border-bottom: none;
    }
    .transaction-item .info {
      flex: 1;
      margin-right: 15px;
    }
    .transaction-item .amount {
      font-weight: 700;
      white-space: nowrap;
    }
    .transaction-item .amount.income { color: var(--income-color); }
    .transaction-item .amount.expense { color: var(--expense-color); }
    .transaction-item h4 {
      margin: 0 0 5px 0;
      font-size: 16px;
    }
    .transaction-item p {
      margin: 0;
      font-size: 12px;
      color: var(--light-text-color);
    }
    .date-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .date-filter input {
      flex: 1;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 8px var(--shadow-color);
      position: relative;
    }
    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-button:hover, .close-button:focus {
      color: #333;
      text-decoration: none;
    }
    #addTransactionForm {
      margin-top: 20px;
    }
    .search-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    .search-input-group input {
      flex: 1;
    }
    #searchTransactionBtn {
      flex: 0;
      padding: 10px 15px;
    }
    #keywordList .card, #searchResult .card {
      padding: 15px;
    }
    #keywordList h4 {
      font-size: 16px;
      color: var(--text-color);
      margin: 0 0 10px 0;
    }
    .keyword-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed var(--border-color);
    }
    .keyword-item:last-child {
      border-bottom: none;
    }
    .keyword-item .keyword-text {
      flex: 1;
      color: var(--light-text-color);
      margin-right: 10px;
    }
    .keyword-item .delete-btn {
      color: var(--expense-color);
      font-size: 14px;
      cursor: pointer;
    }
    #addKeywordForm, #addCategoryForm {
      margin-top: 15px;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 250px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -125px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .button-container .btn {
      flex-grow: 1;
      width: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Sổ Tay Tài Chính</h2>
    </div>

    <div class="tabs">
      <div class="tab-button active" onclick="openTab(event, 'tab1')">Tổng Quan</div>
      <div class="tab-button" onclick="openTab(event, 'tab2')">Giao Dịch</div>
      <div class="tab-button" onclick="openTab(event, 'tab3')">Biểu Đồ</div>
      <div class="tab-button" onclick="openTab(event, 'tab4')">Tìm Kiếm</div>
      <div class="tab-button" onclick="openTab(event, 'tab5')">Phân Loại</div>
    </div>

    <div id="tab1" class="tab-content active">
      <div class="card">
        <h3>Tổng Quan Tài Chính</h3>
        <div class="date-filter">
          <input type="date" id="startDate" class="date-filter-input">
          <input type="date" id="endDate" class="date-filter-input">
        </div>
        <div class="summary-grid" id="summaryGrid">
          <div class="summary-item">
            <p>Thu Nhập</p>
            <h4 class="income" id="totalIncome">0 VNĐ</h4>
          </div>
          <div class="summary-item">
            <p>Chi Tiêu</p>
            <h4 class="expense" id="totalExpense">0 VNĐ</h4>
          </div>
          <div class="summary-item">
            <p>Số Dư</p>
            <h4 class="balance" id="totalBalance">0 VNĐ</h4>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Chi Tiêu Theo Phân Loại</h3>
        <div class="loading-indicator" id="categoryLoading">Đang tải...</div>
        <ul class="category-list" id="expenseCategoryList"></ul>
      </div>

      <div class="card">
        <h3>Thu Chi Theo Tháng</h3>
        <div class="loading-indicator" id="monthlyChartLoading">Đang tải...</div>
        <div class="chart-container">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
    </div>

    <div id="tab2" class="tab-content">
      <div class="card">
        <h3>Thêm Giao Dịch</h3>
        <div class="button-container">
          <button class="btn btn-primary" onclick="openAddTransactionModal('Thu nhập')">Thêm Thu Nhập</button>
          <button class="btn btn-danger" onclick="openAddTransactionModal('Chi tiêu')">Thêm Chi Tiêu</button>
        </div>
      </div>

      <div class="card">
        <h3>Giao Dịch Gần Nhất</h3>
        <div class="form-group">
          <select id="transactionMonthFilter">
            <option value="current">Tháng này</option>
            <option value="1">Tháng 1</option>
            <option value="2">Tháng 2</option>
            <option value="3">Tháng 3</option>
            <option value="4">Tháng 4</option>
            <option value="5">Tháng 5</option>
            <option value="6">Tháng 6</option>
            <option value="7">Tháng 7</option>
            <option value="8">Tháng 8</option>
            <option value="9">Tháng 9</option>
            <option value="10">Tháng 10</option>
            <option value="11">Tháng 11</option>
            <option value="12">Tháng 12</option>
          </select>
        </div>
        <div class="loading-indicator" id="transactionLoading">Đang tải...</div>
        <ul class="transaction-list" id="recentTransactions"></ul>
      </div>
    </div>

    <div id="tab3" class="tab-content">
      <div class="card">
        <h3>Phân Tích Chi Tiêu</h3>
        <div class="form-group">
          <select id="chartDateFilter">
            <option value="currentMonth">Tháng này</option>
            <option value="1">Tháng 1</option>
            <option value="2">Tháng 2</option>
            <option value="3">Tháng 3</option>
            <option value="4">Tháng 4</option>
            <option value="5">Tháng 5</option>
            <option value="6">Tháng 6</option>
            <option value="7">Tháng 7</option>
            <option value="8">Tháng 8</option>
            <option value="9">Tháng 9</option>
            <option value="10">Tháng 10</option>
            <option value="11">Tháng 11</option>
            <option value="12">Tháng 12</option>
          </select>
        </div>
        <div class="loading-indicator" id="chartLoading">Đang tải...</div>
        <div class="chart-container">
          <canvas id="expensePieChart"></canvas>
        </div>
      </div>
    </div>

    <div id="tab4" class="tab-content">
      <div class="card">
        <h3>Tìm Kiếm Giao Dịch</h3>
        <div class="form-group">
          <label for="searchMonth">Tháng</label>
          <select id="searchMonth">
            <option value="">Tất cả các tháng</option>
            <option value="1">Tháng 1</option>
            <option value="2">Tháng 2</option>
            <option value="3">Tháng 3</option>
            <option value="4">Tháng 4</option>
            <option value="5">Tháng 5</option>
            <option value="6">Tháng 6</option>
            <option value="7">Tháng 7</option>
            <option value="8">Tháng 8</option>
            <option value="9">Tháng 9</option>
            <option value="10">Tháng 10</option>
            <option value="11">Tháng 11</option>
            <option value="12">Tháng 12</option>
          </select>
        </div>
        <div class="form-group">
          <label for="searchContent">Nội dung</label>
          <input type="text" id="searchContent" placeholder="Nhập từ khóa nội dung">
        </div>
        <div class="form-group">
          <label for="searchAmount">Số tiền</label>
          <input type="number" id="searchAmount" placeholder="Nhập số tiền">
        </div>
        <div class="form-group">
          <label for="searchCategory">Phân loại chi tiết</label>
          <input type="text" id="searchCategory" placeholder="Nhập phân loại">
        </div>
        <button class="btn btn-primary" onclick="searchTransactions()">Tìm Kiếm</button>
      </div>

      <div class="card" id="searchResult">
        <h3>Kết Quả Tìm Kiếm</h3>
        <div class="loading-indicator" id="searchLoading"></div>
        <ul class="transaction-list" id="searchResultsList"></ul>
      </div>
    </div>

    <div id="tab5" class="tab-content">
      <div class="card">
        <h3>Quản Lý Phân Loại & Từ Khóa</h3>
        <div class="form-group">
          <label for="addKeywordCategory">Phân loại</label>
          <input type="text" id="addKeywordCategory" placeholder="Nhập phân loại (VD: Ăn uống)">
        </div>
        <div class="form-group">
          <label for="addKeywordText">Từ khóa <span class="tooltip">?
            <span class="tooltiptext">Các từ khóa giúp bot tự động phân loại giao dịch. Ví dụ: 'cà phê, trà sữa' cho danh mục 'Giải trí'.</span>
          </span></label>
          <textarea id="addKeywordText" placeholder="Nhập từ khóa, cách nhau bởi dấu phẩy"></textarea>
        </div>
        <button class="btn btn-primary" onclick="addKeyword()">Lưu Từ Khóa</button>
      </div>

      <div class="card">
        <h3>Danh Sách Từ Khóa</h3>
        <div class="loading-indicator" id="keywordsLoading">Đang tải...</div>
        <div id="keywordList"></div>
      </div>
    </div>

  </div>

  <div id="transactionModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">&times;</span>
      <h3 id="modalTitle">Thêm Giao Dịch</h3>
      <form id="transactionForm">
        <input type="hidden" id="transactionId">
        <input type="hidden" id="transactionType">
        <div class="form-group">
          <label for="transactionDate">Ngày</label>
          <input type="date" id="transactionDate" required>
        </div>
        <div class="form-group">
          <label for="transactionContent">Nội dung</label>
          <input type="text" id="transactionContent" required>
        </div>
        <div class="form-group">
          <label for="transactionAmount">Số tiền</label>
          <input type="number" id="transactionAmount" required>
        </div>
        <div class="form-group">
          <label for="transactionCategory">Phân loại chi tiết</label>
          <input type="text" list="categoryOptions" id="transactionCategory" required>
          <datalist id="categoryOptions"></datalist>
        </div>
        <div class="form-group">
          <label for="transactionNote">Ghi chú</label>
          <textarea id="transactionNote"></textarea>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-primary" id="saveTransactionBtn">Lưu Giao Dịch</button>
          <button type="button" class="btn btn-danger" id="deleteTransactionBtn" style="display: none;">Xóa</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script>
    var globalState = {
      sheetId: "<?= SHEET_ID ?>",
      api: "<?= ScriptApp.getService().getUrl() ?>",
      transactionCache: [],
      categoriesCache: [],
      keywordsCache: []
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Thiết lập ngày mặc định
      var today = new Date();
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var dd = String(today.getDate()).padStart(2, '0');
      var todayStr = yyyy + '-' + mm + '-' + dd;
      document.getElementById('startDate').value = yyyy + '-' + mm + '-01';
      document.getElementById('endDate').value = todayStr;
      document.getElementById('transactionDate').value = todayStr;

      // Thiết lập tháng mặc định cho các bộ lọc
      var currentMonth = today.getMonth() + 1;
      document.getElementById('transactionMonthFilter').value = currentMonth;
      document.getElementById('chartDateFilter').value = 'currentMonth';

      // Load dữ liệu ban đầu
      loadAllData();

      // Gán sự kiện cho các bộ lọc
      document.getElementById('startDate').addEventListener('change', loadSummary);
      document.getElementById('endDate').addEventListener('change', loadSummary);
      document.getElementById('transactionMonthFilter').addEventListener('change', loadTransactionsByMonth);
      document.getElementById('chartDateFilter').addEventListener('change', loadExpensePieChart);

      // Gán sự kiện cho form
      document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
    });

    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tab-button");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
      
      // Load dữ liệu khi chuyển tab
      if (tabName === 'tab1') loadSummary();
      if (tabName === 'tab2') loadTransactionsByMonth();
      if (tabName === 'tab3') loadExpensePieChart();
      if (tabName === 'tab5') loadKeywords();
    }

    // --- Các hàm gọi Apps Script ---
    function callAppsScript(action, params = {}, successHandler, errorHandler) {
      showLoading(action);
      const url = `${globalState.api}?action=${action}&sheetId=${globalState.sheetId}&${new URLSearchParams(params).toString()}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            errorHandler(data.error);
          } else {
            successHandler(data);
          }
          hideLoading(action);
        })
        .catch(error => {
          console.error("Error calling Apps Script:", error);
          errorHandler("Lỗi kết nối: " + error.message);
          hideLoading(action);
        });
    }

    function callAppsScriptPost(action, payload, successHandler, errorHandler) {
      showLoading(action);
      fetch(globalState.api, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...payload, action: action, sheetId: globalState.sheetId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          errorHandler(data.error);
        } else {
          successHandler(data);
        }
        hideLoading(action);
      })
      .catch(error => {
        console.error("Error POSTing to Apps Script:", error);
        errorHandler("Lỗi kết nối: " + error.message);
        hideLoading(action);
      });
    }

    function showLoading(action) {
      const loadingMap = {
        'getFinancialSummary': 'categoryLoading',
        'getChartData': 'chartLoading',
        'getMonthlyData': 'monthlyChartLoading',
        'getTransactionsByMonth': 'transactionLoading',
        'getKeywords': 'keywordsLoading',
        'searchTransactions': 'searchLoading'
      };
      const elementId = loadingMap[action];
      if (elementId) {
        document.getElementById(elementId).innerText = "Đang tải...";
        document.getElementById(elementId).classList.remove('hidden');
      }
    }

    function hideLoading(action) {
      const loadingMap = {
        'getFinancialSummary': 'categoryLoading',
        'getChartData': 'chartLoading',
        'getMonthlyData': 'monthlyChartLoading',
        'getTransactionsByMonth': 'transactionLoading',
        'getKeywords': 'keywordsLoading',
        'searchTransactions': 'searchLoading'
      };
      const elementId = loadingMap[action];
      if (elementId) {
        document.getElementById(elementId).innerText = "";
        document.getElementById(elementId).classList.add('hidden');
      }
    }

    function showAlert(message) {
      // Có thể thay bằng thư viện UI đẹp hơn
      alert(message);
    }
    
    // --- CÁC HÀM XỬ LÝ GIAO DIỆN (UI) ---
    function loadAllData() {
      loadSummary();
      loadMonthlyChart();
      loadCategories();
    }

    function loadSummary() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const params = { startDate: startDate, endDate: endDate };

      callAppsScript('getFinancialSummary', params, (summary) => {
        document.getElementById('totalIncome').innerText = formatCurrency(summary.income);
        document.getElementById('totalExpense').innerText = formatCurrency(summary.expense);
        document.getElementById('totalBalance').innerText = formatCurrency(summary.balance);
        displayExpenseCategories(summary.expenseCategories);
      }, (error) => {
        showAlert("Lỗi khi tải tổng quan: " + error);
      });
    }

    function loadTransactionsByMonth() {
      var select = document.getElementById('transactionMonthFilter');
      var month = select.value === 'current' ? new Date().getMonth() + 1 : select.value;
      var year = new Date().getFullYear();

      const params = { month: month, year: year };
      
      callAppsScript('getTransactionsByMonth', params, (transactions) => {
        if (transactions.error) {
          showAlert(transactions.error);
          document.getElementById('recentTransactions').innerHTML = '<li>Không có giao dịch trong tháng này.</li>';
          return;
        }
        globalState.transactionCache = transactions;
        displayTransactions(transactions);
      }, (error) => {
        showAlert("Lỗi khi tải giao dịch: " + error);
      });
    }

    function displayTransactions(transactions) {
      const list = document.getElementById('recentTransactions');
      list.innerHTML = '';
      if (!transactions || transactions.length === 0) {
        list.innerHTML = '<li>Không có giao dịch nào.</li>';
        return;
      }
      transactions.forEach(t => {
        const item = document.createElement('li');
        item.className = 'transaction-item';
        item.onclick = () => openEditTransactionModal(t);
        item.innerHTML = `
          <div class="info">
            <h4>${t.content} (${t.id})</h4>
            <p>${t.date} | ${t.category}</p>
          </div>
          <div class="amount ${t.type.toLowerCase() === 'thu nhập' ? 'income' : 'expense'}">${formatCurrency(t.amount)}</div>
        `;
        list.appendChild(item);
      });
    }

    function loadCategories() {
      callAppsScript('getCategories', {}, (categories) => {
        globalState.categoriesCache = categories;
        const datalist = document.getElementById('categoryOptions');
        datalist.innerHTML = '';
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          datalist.appendChild(option);
        });
      }, (error) => {
        showAlert("Lỗi khi tải danh mục: " + error);
      });
    }

    function loadKeywords() {
      callAppsScript('getKeywords', {}, (keywordsData) => {
        if (keywordsData.error) {
          showAlert(keywordsData.error);
          document.getElementById('keywordList').innerHTML = 'Không có từ khóa nào.';
          return;
        }
        globalState.keywordsCache = keywordsData;
        displayKeywords(keywordsData);
      }, (error) => {
        showAlert("Lỗi khi tải từ khóa: " + error);
      });
    }

    function displayKeywords(keywordsData) {
      const listContainer = document.getElementById('keywordList');
      listContainer.innerHTML = '';
      if (!keywordsData || keywordsData.length === 0) {
        listContainer.innerHTML = 'Không có từ khóa nào.';
        return;
      }
      keywordsData.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h4>${item.icon} ${item.category}</h4>
          <ul class="category-list"></ul>
        `;
        const keywordList = card.querySelector('.category-list');
        const keywords = item.keywords.split(',').map(k => k.trim()).filter(k => k);
        keywords.forEach(keyword => {
          const li = document.createElement('li');
          li.className = 'keyword-item';
          li.innerHTML = `
            <span class="keyword-text">${keyword}</span>
            <span class="delete-btn" onclick="deleteKeyword('${item.category}', '${keyword}')">Xóa</span>
          `;
          keywordList.appendChild(li);
        });
        listContainer.appendChild(card);
      });
    }

    function displayExpenseCategories(categories) {
      const list = document.getElementById('expenseCategoryList');
      list.innerHTML = '';
      if (!categories || categories.length === 0) {
        list.innerHTML = '<li>Không có chi tiêu nào trong khoảng thời gian này.</li>';
        return;
      }
      categories.sort((a, b) => b.amount - a.amount).forEach(c => {
        const item = document.createElement('li');
        item.innerHTML = `<span class="label">${c.category}</span><span class="amount">${formatCurrency(c.amount)}</span>`;
        list.appendChild(item);
      });
    }

    // --- CÁC HÀM BIỂU ĐỒ ---
    var expensePieChart = null;
    var monthlyChart = null;
    
    function loadExpensePieChart() {
      const select = document.getElementById('chartDateFilter');
      const month = select.value === 'currentMonth' ? new Date().getMonth() + 1 : select.value;
      const year = new Date().getFullYear();

      const params = { month: month, year: year };

      callAppsScript('getChartData', params, (data) => {
        if (data.error) {
          showAlert(data.error);
          return;
        }
        updatePieChart(data);
      }, (error) => {
        showAlert("Lỗi khi tải biểu đồ: " + error);
      });
    }

    function updatePieChart(data) {
      const canvas = document.getElementById('expensePieChart');
      if (expensePieChart) {
        expensePieChart.destroy();
      }

      const labels = data.chartData.map(d => d.category);
      const values = data.chartData.map(d => d.amount);
      const totalAmount = values.reduce((sum, current) => sum + current, 0);

      const backgroundColors = generateColors(labels.length);
      
      expensePieChart = new Chart(canvas, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: backgroundColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const percentage = totalAmount > 0 ? ((value / totalAmount) * 100).toFixed(1) : 0;
                  return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    function loadMonthlyChart() {
      const year = new Date().getFullYear();
      callAppsScript('getMonthlyData', { year: year }, (data) => {
        if (data.error) {
          showAlert(data.error);
          return;
        }
        updateMonthlyChart(data);
      }, (error) => {
        showAlert("Lỗi khi tải biểu đồ tháng: " + error);
      });
    }
    
    function updateMonthlyChart(data) {
      const canvas = document.getElementById('monthlyChart');
      if (monthlyChart) {
        monthlyChart.destroy();
      }

      const labels = data.map(d => `T${d.month}`);
      const incomeData = data.map(d => d.income);
      const expenseData = data.map(d => d.expense);

      monthlyChart = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Thu Nhập',
            data: incomeData,
            backgroundColor: varToRgb('--income-color', 0.6),
            borderColor: varToRgb('--income-color', 1),
            borderWidth: 1
          }, {
            label: 'Chi Tiêu',
            data: expenseData,
            backgroundColor: varToRgb('--expense-color', 0.6),
            borderColor: varToRgb('--expense-color', 1),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                }
              }
            }
          }
        }
      });
    }

    // --- CÁC HÀM XỬ LÝ MODAL VÀ FORM ---
    function openAddTransactionModal(type) {
      document.getElementById('modalTitle').innerText = `Thêm Giao Dịch ${type}`;
      document.getElementById('transactionId').value = '';
      document.getElementById('transactionType').value = type;
      document.getElementById('transactionContent').value = '';
      document.getElementById('transactionAmount').value = '';
      document.getElementById('transactionCategory').value = '';
      document.getElementById('transactionNote').value = '';
      document.getElementById('deleteTransactionBtn').style.display = 'none';
      document.getElementById('saveTransactionBtn').innerText = 'Thêm Giao Dịch';
      document.getElementById('transactionModal').style.display = 'block';
      loadCategories(); // Đảm bảo danh mục luôn được cập nhật
    }

    function openEditTransactionModal(transaction) {
      document.getElementById('modalTitle').innerText = `Sửa Giao Dịch (${transaction.id})`;
      document.getElementById('transactionId').value = transaction.id;
      document.getElementById('transactionType').value = transaction.type;
      document.getElementById('transactionDate').value = formatDateForInput(transaction.date);
      document.getElementById('transactionContent').value = transaction.content;
      document.getElementById('transactionAmount').value = transaction.amount;
      document.getElementById('transactionCategory').value = transaction.category;
      document.getElementById('transactionNote').value = transaction.note;
      document.getElementById('deleteTransactionBtn').style.display = 'inline-block';
      document.getElementById('saveTransactionBtn').innerText = 'Lưu Thay Đổi';
      document.getElementById('transactionModal').style.display = 'block';
      loadCategories();
    }

    function closeModal() {
      document.getElementById('transactionModal').style.display = 'none';
    }

    function handleTransactionSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const transaction = {
        id: form.transactionId.value,
        date: form.transactionDate.value.split('-').reverse().join('/'),
        type: form.transactionType.value,
        content: form.transactionContent.value,
        amount: parseFloat(form.transactionAmount.value),
        category: form.transactionCategory.value,
        note: form.transactionNote.value,
      };

      if (transaction.id) {
        // Sửa giao dịch
        const month = new Date(form.transactionDate.value).getMonth() + 1;
        const year = new Date(form.transactionDate.value).getFullYear();
        callAppsScriptPost('updateTransaction', { ...transaction, month, year }, () => {
          showAlert("Sửa giao dịch thành công!");
          closeModal();
          loadAllData();
          loadTransactionsByMonth();
        }, (error) => {
          showAlert("Lỗi khi sửa giao dịch: " + error);
        });
      } else {
        // Thêm giao dịch
        callAppsScriptPost('addTransaction', transaction, () => {
          showAlert("Thêm giao dịch thành công!");
          closeModal();
          loadAllData();
          loadTransactionsByMonth();
        }, (error) => {
          showAlert("Lỗi khi thêm giao dịch: " + error);
        });
      }
    }

    document.getElementById('deleteTransactionBtn').addEventListener('click', function() {
      if (confirm("Bạn có chắc chắn muốn xóa giao dịch này?")) {
        const transactionId = document.getElementById('transactionId').value;
        const date = document.getElementById('transactionDate').value;
        const month = new Date(date).getMonth() + 1;

        callAppsScriptPost('deleteTransaction', { id: transactionId, month: month }, () => {
          showAlert("Xóa giao dịch thành công!");
          closeModal();
          loadAllData();
          loadTransactionsByMonth();
        }, (error) => {
          showAlert("Lỗi khi xóa giao dịch: " + error);
        });
      }
    });

    // --- CÁC HÀM KHÁC ---
    function searchTransactions() {
      const month = document.getElementById('searchMonth').value;
      const content = document.getElementById('searchContent').value;
      const amount = document.getElementById('searchAmount').value;
      const category = document.getElementById('searchCategory').value;

      const params = {
        month: month,
        content: content,
        amount: amount,
        category: category
      };
      
      callAppsScript('searchTransactions', params, (result) => {
        if (result.error) {
          showAlert(result.error);
          document.getElementById('searchResultsList').innerHTML = '<li>' + result.error + '</li>';
          return;
        }
        displayTransactions(result.transactions);
      }, (error) => {
        showAlert("Lỗi khi tìm kiếm: " + error);
      });
    }

    function addKeyword() {
      const category = document.getElementById('addKeywordCategory').value;
      const keywords = document.getElementById('addKeywordText').value;

      if (!category || !keywords) {
        showAlert("Vui lòng điền đầy đủ Phân loại và Từ khóa.");
        return;
      }
      
      callAppsScriptPost('addKeyword', { category, keywords }, () => {
        showAlert("Thêm từ khóa thành công!");
        document.getElementById('addKeywordCategory').value = '';
        document.getElementById('addKeywordText').value = '';
        loadKeywords();
      }, (error) => {
        showAlert("Lỗi khi thêm từ khóa: " + error);
      });
    }

    function deleteKeyword(category, keyword) {
      if (confirm(`Bạn có chắc chắn muốn xóa từ khóa '${keyword}' khỏi danh mục '${category}'?`)) {
        callAppsScriptPost('deleteKeyword', { category, keyword }, () => {
          showAlert("Xóa từ khóa thành công!");
          loadKeywords();
        }, (error) => {
          showAlert("Lỗi khi xóa từ khóa: " + error);
        });
      }
    }
    
    // --- CÁC HÀM HỖ TRỢ ---
    function formatCurrency(num) {
      if (typeof num !== 'number') return '0 VNĐ';
      return num.toLocaleString('vi-VN') + ' VNĐ';
    }

    function formatDateForInput(dateString) {
      const parts = dateString.split('/');
      if (parts.length === 3) {
        const [day, month, year] = parts;
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      }
      return dateString;
    }

    function generateColors(num) {
      const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#E7E9ED', '#A1E8AF', '#F7786B', '#1C3144',
      ];
      const result = [];
      for (let i = 0; i < num; i++) {
        result.push(colors[i % colors.length]);
      }
      return result;
    }

    function varToRgb(cssVar, opacity) {
      const color = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
      if (!color) return `rgba(0,0,0,${opacity})`;
      return color.replace(')', `, ${opacity})`).replace('rgb', 'rgba');
    }
  </script>
</body>
</html>
